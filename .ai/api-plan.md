# REST API Plan

## 1. Resources

- Training Types → table: `training_types`
- Workouts → table: `workouts`
- AI Suggestions → table: `ai_suggestions`
- AI Suggestion Events → table: `ai_suggestion_events`
- User Goal → table: `user_goals`
- AI Logs (service-only) → table: `ai_logs`

Notes
- All data is scoped by `user_id` and RLS enforces `user_id = auth.uid()` on select/insert/update/delete, except `ai_logs` which is service-only.
- Timestamps are UTC. `planned_date` is a date (UTC); significant moments are `timestamptz`.
- Primary keys are UUIDs generated by DB.
- Enumerations: `workout_status`, `workout_rating`, `workout_origin`, `ai_suggestion_status`, `ai_event_kind`, `goal_type`.
- Expiration:
  - AI suggestions expire after 24h (application logic).
  - Training types support ETag caching (If-None-Match) to optimize reads, returning 304 Not Modified when content unchanged.

Conventions
- Base URL: `/api/v1`
- Auth: `Authorization: Bearer <supabase_jwt>` (or session cookie if SSR). All endpoints require auth unless stated otherwise.
- Pagination: `page`, `per_page` (default `page=1`, `per_page=20`, max 100) with `total`, `page`, `per_page` in response.
- Sorting: `sort` query param with `field:direction` (e.g., `completed_at:desc`). Multiple fields comma-separated.
- Filtering: resource-specific query params; unknown filters return 422 with `details.invalid_params` listing the offending names.
 - Filtering: resource-specific query params; unknown filters return 422 with `details.invalid_params` listing the offending names.
 - Comparison filters: `*_gte`/`*_lte` are inclusive; `*_after`/`*_before` are exclusive.
- Response shape:
  - All successful responses use an envelope: `{ "data": ... }`.
  - List endpoints additionally include `page`, `per_page`, `total` alongside `data`.
- Error envelope (all 4xx/5xx):

```json
{
  "error": {
    "code": "STRING_MACHINE_CODE",
    "message": "Human-readable message",
    "details": { "optional": "context" },
    "request_id": "uuid"
  }
}
```

---

## 2. Endpoints

### 2.1 Training Types (read-only for users)

- GET `/api/v1/training-types`
  - Description: List active training types.
  - Query params:
    - `include_inactive` (boolean, default false) — service/admin only.
  - Request headers:
    - `If-None-Match` (optional) — ETag from previous response; server returns 304 Not Modified if content unchanged.
  - Response 200:
    - Headers:
      - `ETag` — Hash of training types content for cache validation.
      - `Cache-Control: private, max-age=3600, stale-while-revalidate=86400`
```
{
  "data": [
    { "code": "easy", "name": "Easy Run", "is_active": true, "created_at": "2025-10-11T00:00:00Z" }
  ],
  "page": 1,
  "per_page": 20,
  "total": 6
}
```

No Data changes
- 304 Not Modified 

Errors
- 401 unauthorized
- 403 forbidden (when `include_inactive=true` without privileges)

Notes on performance
- Reads are small and can be cached (private, max-age=3600, stale-while-revalidate).

---

### 2.2 Workouts

Common fields
- Plan fields (required on create for planned workouts): `training_type_code`, `planned_date`, `position`, `planned_distance_m`, `planned_duration_s`.
- Realization fields (required only for `status=completed`): `distance_m`, `duration_s`, `avg_hr_bpm`, `completed_at`.
- Other: `status`, `rating` (only with completed), `origin`, `ai_suggestion_id`, `steps` (JSON structure, see Validation), `avg_pace_s_per_km` (derived, read-only).

Index alignment
- Listing by calendar uses index `(user_id, planned_date)`.
- Last-3 by type uses `(user_id, training_type_code, completed_at DESC)`.
- Last-3 overall uses `(user_id, completed_at DESC)`.

Schema shapes

```json
// Workout summary (list)
{
  "id": "uuid",
  "training_type_code": "easy",
  "planned_date": "2025-10-13",
  "position": 1,
  "planned_distance_m": 5000,
  "planned_duration_s": 1800,
  "status": "planned",
  "origin": "manual",
  "rating": null,
  "avg_pace_s_per_km": null
}

// Workout detail (get)
{
  "id": "uuid",
  "user_id": "uuid",
  "training_type_code": "easy",
  "planned_date": "2025-10-13",
  "position": 1,
  "planned_distance_m": 5000,
  "planned_duration_s": 1800,
  "status": "completed",
  "origin": "ai",
  "ai_suggestion_id": "uuid",
  "steps": [
    { "part": "warmup", "distance_m": 1000, "duration_s": 600 },
    { "part": "main", "distance_m": 3000, "duration_s": 1200 },
    { "part": "cooldown", "distance_m": 1000, "duration_s": 600 }
  ],
  "distance_m": 5200,
  "duration_s": 1850,
  "avg_hr_bpm": 145,
  "completed_at": "2025-10-13T18:30:00Z",
  "rating": "just_right",
  "avg_pace_s_per_km": 356
}
```

Endpoints

- GET `/api/v1/workouts`
  - Description: List workouts for the authenticated user.
  - Query params:
    - `status` in `planned,completed,skipped,canceled` (optional)
    - `training_type_code` (optional, multi allowed: comma-separated)
    - `origin` in `manual,ai,import` (optional)
    - `rating` in `too_easy,just_right,too_hard` (optional)
    - `planned_date_gte`, `planned_date_lte` (YYYY-MM-DD) — calendar view
    - `completed_at_gte`, `completed_at_lte` (ISO 8601)
    - `sort` default: `planned_date:asc,position:asc` if `status!=completed`; if `status=completed` default `completed_at:desc`
    - `page`, `per_page`
  - Response 200:

```json
{
  "data": [ { "id": "uuid", "training_type_code": "easy", "planned_date": "2025-10-13", "position": 1, "status": "planned" } ],
  "page": 1,
  "per_page": 20,
  "total": 42
}
```
  - Errors: 401, 422 invalid filters

- POST `/api/v1/workouts`
  - Description: Create a planned or completed workout (manual origin by default).
  - Request JSON (planned):

```json
{
  "training_type_code": "easy",
  "planned_date": "2025-10-15",
  "position": 1,
  "planned_distance_m": 5000,
  "planned_duration_s": 1800,
  "steps": [
    { "part": "warmup", "duration_s": 600 },
    { "part": "main", "duration_s": 900 },
    { "part": "cooldown", "duration_s": 300 }
  ]
}
```

  - Request JSON (completed):

```json
{
  "training_type_code": "easy",
  "planned_date": "2025-10-15",
  "position": 1,
  "planned_distance_m": 5000,
  "planned_duration_s": 1800,
  "status": "completed",
  "distance_m": 5000,
  "duration_s": 1800,
  "avg_hr_bpm": 140,
  "completed_at": "2025-10-15T18:00:00Z",
  "rating": "just_right"
}
```
  - Response 201:

```json
{ "data": { /* workout detail */ } }
```
  - Errors: 400; 422 validation; 401; 409 duplicate `position` per `planned_date`; 404 invalid `training_type_code` or foreign keys; 403 user mismatch

- GET `/api/v1/workouts/{id}`
  - Description: Get workout detail.
  - Response 200:

```json
{ "data": { /* workout detail */ } }
```
  - Errors: 401, 404

- PATCH `/api/v1/workouts/{id}`
  - Description: Update mutable fields. Use for minor edits (plan adjustments, fix metrics).
  - Request JSON: any subset of fields except immutable: `id`, `user_id`, `origin`, `ai_suggestion_id` (immutable once set), and constraints described in Validation.
  - Response 200: workout detail
  - Errors: 400/422, 401, 404, 409 status transition conflict

- DELETE `/api/v1/workouts/{id}`
  - Description: Delete a workout. If the workout was created by accepting an AI suggestion, deletion may be restricted by FK (recommend returning 409 Conflict with remediation hint to revert acceptance instead).
  - Response 204
  - Errors: 401, 404, 409 cannot delete accepted AI workout

Domain actions (clearer semantics and validation)

-- POST `/api/v1/workouts/{id}/complete`
  - Description: Mark a planned workout as completed, with required metrics.
  - Request JSON:

```json
{ "distance_m": 5200, "duration_s": 1850, "avg_hr_bpm": 145, "completed_at": "2025-10-13T18:30:00Z", "rating": "just_right" }
```

  - Response 200:

```json
{ "data": { /* workout detail (status becomes completed) */ } }
```
  - Errors: 400/422 missing required metrics; 409 if not in a valid state

-- POST `/api/v1/workouts/{id}/skip`
  - Description: Mark as skipped. Clears realization metrics and rating.
  - Response 200:

```json
{ "data": { /* workout detail (status skipped) */ } }
```
  - Errors: 409 invalid transition

-- POST `/api/v1/workouts/{id}/cancel`
  - Description: Mark as canceled (e.g., plan change). Clears realization metrics and rating.
  - Response 200:

```json
{ "data": { /* workout detail (status canceled) */ } }
```
  - Errors: 409 invalid transition

-- POST `/api/v1/workouts/{id}/rate`
  - Description: Set rating for a completed workout.
  - Request JSON:

```json
{ "rating": "too_hard" }
```

  - Response 200:

```json
{ "data": { /* workout detail */ } }
```
  - Errors: 409 if status != completed; 422 invalid rating, 404 workout not found

- GET `/api/v1/workouts/last3`
  - Description: Convenience endpoint to fetch up to last 3 completed workouts.
  - Query params:
    - `training_type_code` (optional). If omitted, returns overall last 3.
  - Response 200:

```json
{
  "data": [ { "id": "uuid", "completed_at": "2025-10-13T18:30:00Z", "training_type_code": "easy" } ],
  "page": 1,
  "per_page": 3,
  "total": 1
}
```

- GET `/api/v1/calendar`
  - Description: Calendar view. Returns workouts grouped by `planned_date` within range.
  - Query params: `start` (YYYY-MM-DD), `end` (YYYY-MM-DD), required; `status` optional.
  - Response 200:

```json
{ "data": {
  "range": { "start": "2025-10-01", "end": "2025-10-31" },
  "days": [ { "date": "2025-10-13", "workouts": [ { "id": "uuid", "training_type_code": "easy", "status": "planned", "position": 1 } ] } ]
} }
```

---

### 2.4 AI Suggestions

Statuses: `shown`, `accepted`, `rejected`, `expired`

Shared representation

> **Implementation note (MVP)**  
> Wszystkie metadane sugestii (planowana data, łączny dystans/czas, kontekst AI) są przechowywane wewnątrz pola `steps_jsonb` jako struktura `meta + steps`. Endpointy odczytują je z JSON i zwracają płaskie pola (np. `planned_date`) wyłącznie na poziomie DTO.

```json
{
  "id": "uuid",
  "user_id": "uuid",
  "training_type_code": "easy",
  "planned_date": "2025-10-16",
  "steps": [
    { "part": "warmup", "duration_s": 600 },
    { "part": "main", "duration_s": 1200 },
    { "part": "cooldown", "duration_s": 600 }
  ],
  "status": "shown",
  "accepted_workout_id": null,
  "created_at": "2025-10-13T09:00:00Z",
  "updated_at": "2025-10-13T09:00:00Z",
  "expires_at": "2025-10-14T09:00:00Z" // computed in API
}
```

Endpoints

- GET `/api/v1/ai/suggestions`
  - Description: List suggestions for the user. Does not mutate state; expiration is handled by a scheduled job (hourly) and computed as `created_at + 24h`.
  - Query params: `status` (optional), `created_after`, `created_before`, `page`, `per_page`, `sort` (default `created_at:desc`)
  - Response 200:

```json
{
  "data": [ { "id": "uuid", "status": "shown", "planned_date": "2025-10-16" } ],
  "page": 1,
  "per_page": 20,
  "total": 5
}
```

-- POST `/api/v1/ai/suggestions`
  - Description: Generate a suggestion for a date and type. Enforces regeneration limit (3 per day). Applies calibration logic for the first 3 AI-generated workouts.
  - Request JSON:

```json
{
  "planned_date": "2025-10-16",
  "training_type_code": "easy",
  "context": { "notes": "optional user hints" }
}
```

  - Response 201:

```json
{ "data": { /* suggestion (status shown) */ } }
```
  - Errors: 401, 422 invalid inputs, 429 regeneration/day limit reached

- GET `/api/v1/ai/suggestions/{id}`
  - Description: Get a suggestion detail.
  - Response 200:

```json
{ "data": { /* suggestion */ } }
```
  - Errors: 404, 410 if expired and `include_expired=false` (default)

-- POST `/api/v1/ai/suggestions/{id}/accept`
  - Description: Accept a suggestion and create a workout (`origin=ai`). Ensures 1–1 mapping and type/date consistency.
  - Request JSON:

```json
{ "position": 1 }
```

  - Response 201:

```json
{ "data": { /* workout detail; suggestion becomes accepted */ } }
```

  - Errors: 404, 409 already accepted/conflicting position, 410 expired, 403 user mismatch

- POST `/api/v1/ai/suggestions/{id}/reject`
  - Description: Reject a suggestion (status `rejected`).
  - Response 200:

```json
{ "data": { /* suggestion */ } }
```
  - Errors: 404, 409 already accepted, 410 expired, 403 user mismatch

- POST `/api/v1/ai/suggestions/{id}/regenerate`
  - Description: Regenerate a new suggestion (creates a new suggestion linked by event log). Enforces per-user daily limit (3/day).
  - Request JSON (optional):

```json
{ "reason": "too hard", "adjustment_hint": "-10% distance" }
```

  - Response 201: new suggestion object
  - Errors: 404 (base suggestion not found), 410 expired, 429 limit reached, 403 user mismatch

Notes
- Regeneration and acceptance must be atomic and consistent (DB transaction). Enforce `(ai_suggestion_id) IS UNIQUE` where not null on workouts.
- Expiration is computed as `created_at + 24h`. Expired suggestions are read-only.

---

### 2.5 AI Suggestion Events (service/user audit)

- GET `/api/v1/ai/suggestions/{id}/events`
  - Description: List events for a suggestion (primarily `regenerate`).
  - Response 200:

```json
{
  "data": [ { "id": "uuid", "kind": "regenerate", "occurred_at": "2025-10-13T10:00:00Z", "metadata": { "note": "user requested" } } ],
  "total": 1,
  "page": 1,
  "per_page": 20
}
```

Errors
- 401, 403 (cross-user access), 404 suggestion not found

---

### 2.6 User Goal (1 per user in MVP)

- GET `/api/v1/user-goal`
  - Description: Get current user goal or `null` if not set.
  - Response 200:

```json
{ "data": { "goal_type": "distance_by_date", "target_distance_m": 100000, "due_date": "2025-12-31", "notes": "Berlin Half" } }
```

- PUT `/api/v1/user-goal`
  - Description: Upsert the single user goal (creates or replaces).
  - Request JSON:

```json
{ "goal_type": "distance_by_date", "target_distance_m": 100000, "due_date": "2025-12-31", "notes": "optional" }
```

  - Response 200:

```json
{ "data": { /* goal */ } }
```
  - Errors: 422 validation

- DELETE `/api/v1/user-goal`
  - Description: Delete user goal (sets to none).
  - Response 204
  - Errors: 404 if not set

---

### 2.7 AI Logs (internal, service-role only)

- POST `/api/v1/internal/ai/logs`
  - Description: Ingest AI interaction logs for diagnostics and cost tracking.
  - Auth: service-role key only.
  - Request JSON (example):

```json
{
  "event": "suggestion.generate",
  "level": "info",
  "model": "gpt-4o-mini",
  "provider": "openrouter",
  "latency_ms": 450,
  "input_tokens": 1200,
  "output_tokens": 300,
  "cost_usd": 0.015,
  "payload": { "user_id": "uuid", "suggestion_id": "uuid" }
}
```

  - Response 202: accepted
  - Errors: 401/403

- GET `/api/v1/internal/ai/logs`
  - Description: Admin-only logs listing with filters and pagination.
  - Response 200:

```json
{
  "data": [ { "id": "uuid", "event": "suggestion.generate", "level": "info" } ],
  "page": 1,
  "per_page": 20,
  "total": 120
}
```

---

## 3. Authentication and Authorization

- Mechanism: Supabase Auth (email/password or other providers), JWT-based. Endpoints expect `Authorization: Bearer <token>` header, or SSR session cookie resolved on the server.
- RLS: Enabled on `workouts`, `ai_suggestions`, `ai_suggestion_events`, `user_goals` with policies `USING/WITH CHECK user_id = auth.uid()`.
- Service-role: `ai_logs` accessible only with service-role key; RLS typically disabled there. Protect internal endpoints behind server-only secrets and network-level ACL (no browser exposure).
- Scope: All CRUD operations implicitly scoped to the authenticated user via RLS; no need to pass `user_id` in payloads.
- CSRF: For browser cookie-based auth, use double-submit token or same-site cookies on mutating requests. If only Bearer, CSRF risk is lower; still require `Content-Type: application/json` and reject `text/plain`.
- Permissions:
  - Standard user: full CRUD on own workouts and goal; read-only on training types, own suggestions/events; create/regenerate/accept/reject own suggestions.
  - Admin/service: manage training type dictionary and internal logs.

---

## 4. Validation and Business Logic

Global
- All times are UTC. `planned_date` must be a valid date string `YYYY-MM-DD`.
- Rate limiting: 60 req/min/user general; 3 regenerations per user per UTC day.

Workouts
- Plan constraints:
  - `planned_distance_m` in [100, 100000]
  - `planned_duration_s` in [300, 21600]
  - `position` ≥ 1 and unique per (`user_id`, `planned_date`)
  - `training_type_code` must exist and be active
- Realization constraints (only for `status=completed`):
  - `distance_m` in [100, 100000]
  - `duration_s` in [300, 21600]
  - `avg_hr_bpm` in [0, 240]
  - `completed_at` required
- Rating: allowed only when `status=completed`; values `too_easy|just_right|too_hard`.
- AI origin coupling: `origin='ai'` iff `ai_suggestion_id` is not null. Enforced both in DB and API.
- Status transitions:
  - planned → completed|skipped|canceled
  - completed → edit metrics/rating only
  - skipped/canceled → back to planned (optional, if supported) — default: not supported in MVP
- Steps JSON (`steps`) minimal schema:

```json
{
  "type": "array",
  "minItems": 1,
  "items": {
    "type": "object",
    "properties": {
      "part": { "type": "string", "enum": ["warmup", "main", "cooldown", "segment"] },
      "distance_m": { "type": "integer", "minimum": 0 },
      "duration_s": { "type": "integer", "minimum": 0 },
      "notes": { "type": "string" }
    },
    "anyOf": [
      { "required": ["distance_m"] },
      { "required": ["duration_s"] }
    ],
    "additionalProperties": false
  }
}
```

- Derived pace: `avg_pace_s_per_km = duration_s / (distance_m/1000)`, set null if missing inputs.

AI Suggestions
- Creation/generation:
  - Requires `planned_date` and `training_type_code`.
  - Applies calibration mode: for the user’s first 3 AI-generated workouts overall, bias intensity conservatively.
  - Progressive logic after calibration: if last 3 completed of the same type are rated `just_right` or `too_easy`, increase planned distance ~10% (bounded by safety caps) for the next suggestion. Fetch using `GET /workouts/last3?training_type_code=...` under the hood.
- Acceptance:
  - Must be within 24h window (`created_at + 24h > now`).
  - Must ensure `training_type_code` matches suggestion; `planned_date` of created workout must match suggestion’s `planned_date`.
  - Enforce 1–1 mapping: set suggestion `status='accepted'`, store `accepted_workout_id` and link `workout.ai_suggestion_id`.
  - Position uniqueness validated; conflicts return 409
- Rejection:
  - Allowed unless already accepted or expired; set `status='rejected'`.
- Regeneration:
  - Allowed up to 3/day per user. Log event in `ai_suggestion_events` with `kind='regenerate'` and `occurred_at=now()`; include `metadata` (optional) with hints.
  - Regeneration returns a new suggestion (`status='shown'`), the previous suggestion stays `rejected` (if user explicitly rejected) or remains `shown` (if user asked to regenerate without rejecting) — choose strategy: default to keeping previous as `rejected`.
- Expiration:
  - Any operation on expired suggestions returns 410 Gone.

User Goal
- Exactly one goal per user in MVP; `PUT /user-goal` upserts.
- Validation: `goal_type='distance_by_date'`, `target_distance_m` > 0, `due_date` is future or present.

Security, Safety, and Performance
- RLS policies ensure per-user isolation without passing `user_id` in payloads.
- Input validation via JSON Schema (Zod/Yup in API layer) mirroring DB checks to fail early with 422 before hitting DB.
- Transaction boundaries:
  - Suggestion acceptance must wrap suggestion update + workout insert atomically.
  - Regeneration must wrap event insert + suggestion insert.
- Index usage:
  - Calendar queries use `(user_id, planned_date)` with date range filter.
  - Progressive logic queries use `(user_id, training_type_code, completed_at DESC)`.
  - Suggestions list filtered by `(user_id, status, created_at DESC)`.
- Rate limiting:
  - Global per IP and per user (e.g., 60 req/min). For AI actions, stricter (e.g., 10 req/min) and 3 regenerations/day cap.
  - Return `429 Too Many Requests` with `Retry-After` header.
- Auditing/logging:
  - Write AI usage to `ai_logs` (service-only). Include request_id in all error responses.
- Privacy:
  - No PII beyond Supabase `auth.users`. Do not log sensitive content in `ai_logs.payload`.

Versioning & Documentation
- Prefix all routes with `/api/v1`.
- Provide OpenAPI 3.1 YAML generated from TypeScript types (future improvement) to keep server and docs in sync.

---

## Appendix: Error Codes (summary)

- 200 OK — Successful read/update
- 201 Created — Resource created
- 202 Accepted — Asynchronous accepted (logs)
- 204 No Content — Successfully deleted
- 400 Bad Request — Malformed input
- 401 Unauthorized — Missing/invalid token
- 403 Forbidden — Not allowed
- 404 Not Found — Resource not found
- 409 Conflict — State conflict (e.g., duplicate position, deletion restricted)
- 410 Gone — Suggestion expired
- 422 Unprocessable Entity — Validation failed
- 429 Too Many Requests — Rate limit exceeded
- 500 Internal Server Error — Unexpected server error


